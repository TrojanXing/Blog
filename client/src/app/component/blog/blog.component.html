<div class="container">
  <h1 class="page-header">Blog Page</h1>
  <hr>
  <!-- Message -->
  <div class="show-hide-message" *ngIf="message">
    <div [ngClass]="messageClass">
      {{ message }}
    </div>
  </div>

  <div *ngIf="!newPost">
    <button type="button" class="btn btn-info blogBtn" (click)="newBlogForm()">New Post</button>
    <button [disabled]="loadingBlog" type="button" class="btn btn-secondary blogBtn" (click)="reloadBlog()">
      <div class="material-icons md-18">autorenew</div>Reload
    </button>
  </div>

  <form [formGroup]="form" name="blogForm" (submit)="onBlogSubmit()" *ngIf="newPost">
    <div class="form-group">
      <label for="blogTitle">Title</label>
      <input type="title" class="form-control" id="blogTitle"
             placeholder="Title" formControlName="title"
             [ngClass]="{'is-valid': form.controls.title.valid,
                       'is-invalid': form.controls.title.errors && form.controls.title.dirty}">
      <ul [ngClass]="{'valid-feedback': form.controls.title.valid,
                    'invalid-feedback': form.controls.title.errors && form.controls.title.dirty}">
        <li *ngIf="form.controls.title.errors?.required && form.controls.title.dirty">This field is required</li>
        <li *ngIf="(form.controls.title.errors?.minlength || form.controls.title.errors?.maxlength) && form.controls.title.dirty">Length between 5 and 50</li>
        <li *ngIf="form.controls.title.errors?.titleValidator && form.controls.title.dirty">Blog title should include only letters and number</li>
        <li *ngIf="titleMessage">{{ titleMessage }}</li>
      </ul>
    </div>
    <div class="form-group">
      <label for="exampleTextarea">Blog</label>
      <textarea class="form-control" id="exampleTextarea" rows="10" cols="50"
                formControlName="body"
                [ngClass]="{'is-valid': form.controls.body.valid,
                       'is-invalid': form.controls.body.errors && form.controls.body.dirty}"></textarea>
      <ul [ngClass]="{'valid-feedback': form.controls.body.valid,
                    'invalid-feedback': form.controls.body.errors && form.controls.body.dirty}">
        <li *ngIf="form.controls.body.errors?.required && form.controls.body.dirty">This field is required</li>
        <li *ngIf="(form.controls.body.errors?.minlength || form.controls.body.errors?.maxlength) && form.controls.body.dirty">Length between 5 and 200</li>
        <li *ngIf="bodyMessage">{{ bodyMessage }}</li>
      </ul>
    </div>
    <button [disabled]="processing || !form.valid" type="submit" class="btn btn-primary" (click)="onBlogSubmit()">Submit</button>
    <button [disabled]="processing" type="button" class="btn btn-secondary" (click)="goBack()">Go Back</button>
  </form><!-- Blog form -->

  <div *ngIf="!newPost">
    <div class="card card-inverse card-info mt-3" *ngFor="let blog of blogPosts">
      <div class="card-header">
        {{ blog.title }}
      </div>
      <div class="card-block">
        <div class="container my-3">
          <p class="card-text">{{ blog.body }}</p>
        </div>
      </div>
      <div class="card-footer">
        <!--Post info-->
        <div class="row mb-2">
          <div class="col-sm-6"><strong>Posted by: </strong>{{ blog.createdBy }}</div>
          <div class="col-sm-6"><strong>Data: </strong>{{ blog.createdAt | date: 'MMM dd, yyyy'}}</div>
          <div class="col-sm-6" *ngIf="username === blog.createdBy"><strong>Likes: </strong>{{blog.likes}}</div>
          <div class="col-sm-6" *ngIf="username === blog.createdBy"><strong>Dislike: </strong>{{blog.dislikes}}</div>
        </div>
        <!--Edit Button-->
        <button [routerLink]="['/edit-blog/', blog._id]" *ngIf="username === blog.createdBy" type="button" class="btn btn-sm btn-info">Edit</button>
        <!--Delete Button-->
        <button (click)="getDeleteTarget(blog)" data-toggle="modal" data-target="#deleteModal"
                *ngIf="username === blog.createdBy" type="button" class="btn btn-sm btn-danger">Delete</button>
        <!-- Like Dropdown -->
          <button *ngIf="username !== blog.createdBy" [disabled]="blog.likedBy.indexOf(username) !== -1" (click)="likeBlog(blog._id)"
                  class="btn btn-success btn-sm" type="button" id="likeDropdownButton"
                  (mouseover)="getTooltipMessage(blog, true)" data-toggle="tooltip" data-placement="bottom"
                  data-html="true" title="{{tooltipMessage}}">
            <i class="material-icons md-18">thumb_up</i>&nbsp;Likes:&nbsp;{{ blog.likes }}
          </button>
          <!--<div class="dropdown-menu" aria-labelledby="likeDropdownButton" *ngIf="blog.likedBy[0]">-->
            <!--<a class="dropdown-item" *ngFor="let likedBy of blog.likedBy" href="#">{{ likedBy }}</a>-->
          <!--</div>-->
        <!-- Dislike dropdown -->
          <button *ngIf="username !== blog.createdBy" [disabled]="blog.dislikedBy.indexOf(username) !== -1" (click)="dislikeBlog(blog._id)"
                  class="btn btn-warning btn-sm" type="button" id="dislikeDropdownButton"  aria-expanded="false"
                  (mouseover)="getTooltipMessage(blog, false)" data-toggle="tooltip" data-placement="bottom"
                  data-html="true" title="{{tooltipMessage}}">
            <i class="material-icons md-18">thumb_down</i>&nbsp;Disikes:&nbsp;{{ blog.dislikes }}
          </button>
          <!--<div class="dropdown-menu" aria-labelledby="dislikeDropdownButton" *ngIf="blog.dislikedBy[0]">-->
            <!--<a class="dropdown-item" href="#" *ngFor="let dislikedBy of blog.dislikedBy">{{ dislikedBy }}</a>-->
          <!--</div>-->
      </div><!-- card footer -->

      <ul class="list-group">
        <li class="list-group-item">
          <button type="button" name="button" class="btn btn-sm btn-outline-info"
                  (click)="draftComment(blog._id)" [disabled]="newComment.indexOf(blog._id) > -1">Post Comment</button>
          <button *ngIf="enabledComment.indexOf(blog._id) === -1 &&
                       blog.comments.length > 0" class="btn btn-sm btn-outline-success">
            <span (click)="expand(blog._id)">Show Comments</span>
          </button>
          <button *ngIf="enabledComment.indexOf(blog._id) > -1" class="btn btn-sm btn-outline-warning">
            <span (click)="collapse(blog._id)">Hide Comments</span>
          </button>

          <br>
          <div *ngIf="newComment.indexOf(blog._id) > -1">
            <form [formGroup]="commentForm" (submit)="postComment(blog._id)">
              <textarea name="comment" id="" cols="30" rows="5" class="form-control mb-1 mt-1" formControlName="comment"
                        [ngClass]="{'is-invalid': commentForm.controls.comment.errors && commentForm.controls.comment.dirty}"></textarea>
              <div>
                <ul [ngClass]="{'invalid-feedback': commentForm.controls.comment.errors}">
                  <li *ngIf="commentForm.controls.comment.errors?.required && commentForm.controls.comment.dirty">This filed is required</li>
                  <li *ngIf="(commentForm.controls.comment.errors?.maxlength || commentForm.controls.comment.errors?.minlength)">The comment contains at least 1 character and at most 200 characters</li>
                </ul>
              </div>
              <button [disabled]="!commentForm.valid" class="btn btn-info btn-sm" (click)="postComment(blog._id)" type="submit">Submit Post</button>
              <button [disabled]="processing" (click)="cancelComment(blog._id)" class="btn btn-danger btn-sm">Cancel </button>
            </form>
          </div>
        </li>

        <li *ngIf="enabledComment.indexOf(blog._id) > -1" class="list-group-item">
          <div *ngFor="let comment of blog.comments">
            <strong>{{ comment.commentor }}:&nbsp; </strong>{{ comment.comment }}
          </div>
        </li>
      </ul><!-- comment -->

    </div><!-- Card -->
  </div>

  <!-- Delete modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog"
       aria-labelledby="deleteModalLabel" aria-hidden="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">Confirm</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Are you sure your want to delete this blog</p>
        </div>
        <div class="modal-footer">
          <button (click)="deleteBlog()" type="button" class="btn btn-danger" data-dismiss="modal">Delete</button>
          <button [disabled]="processing" type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div><!-- ./deleteModal -->

</div>

